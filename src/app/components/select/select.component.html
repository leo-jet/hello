<div class="inline-block" [attr.data-select-id]="instanceId">
  <div>
    <button
      #button
      type="button"
      [attr.id]="instanceId + '-button'"
      [attr.aria-controls]="instanceId + '-menu'"
      (click)="toggle(); $event.stopPropagation()"
      (keydown)="$event.key === 'Escape' && close()"
      [class]="
        'inline-flex items-center gap-2 px-3 py-2 border rounded ' +
        (buttonClass || '')
      "
      aria-haspopup="listbox"
      [attr.aria-expanded]="open()"
    >
      @if (selectedImage()) {
        <img
          [src]="selectedImage()"
          class="w-5 h-5 rounded-full flex-shrink-0"
          alt=""
        />
      } @else if (!selectedImage() && selectedIcon()) {
        <span class="text-base">{{ selectedIcon() }}</span>
      }
      <span class="flex-1 text-left">{{
        selectedLabel() || placeholder
      }}</span>
      <i class="fas fa-chevron-down ml-2 text-sm"></i>
    </button>

    @if (open()) {
    <ul
      #menu
      [attr.id]="instanceId + '-menu'"
      role="listbox"
      [attr.aria-labelledby]="instanceId + '-button'"
      (click)="$event.stopPropagation()"
      [ngStyle]="menuStyles"
      [class]="'fixed bg-white rounded-md shadow-lg py-1 ' + (menuClass || '')"
    >
      @for (opt of normalizedOptions; track getValue(opt)) {
      <li role="option">
        <button
          type="button"
          (click)="selectOption(opt)"
          [class]="
            (itemClass || '') + ' flex items-center w-full text-left px-4 py-2'
          "
        >
          @if (getImage(opt)) {
          <img
            [src]="getImage(opt)"
            class="w-5 h-5 mr-3 rounded-full flex-shrink-0"
          />
          } @else if (!getImage(opt) && getIcon(opt)) {
          <span
            class="inline-flex items-center justify-center w-5 h-5 mr-3 flex-shrink-0"
            >{{ getIcon(opt) }}</span
          >
          }
          <span class="truncate">{{ getLabel(opt) }}</span>
        </button>
      </li>
      } @empty {
      <li class="px-4 py-2 text-sm text-gray-500">No options</li>
      }
    </ul>
    }
  </div>
</div>
