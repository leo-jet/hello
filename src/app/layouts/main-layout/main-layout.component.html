<!-- Layout avec composants réutilisables -->
<div class="flex h-screen overflow-hidden">

  <!-- Sidebar avec ng-content -->
  <app-sidebar
    [isOpen]="sidebarOpen()"
    (closeEvent)="closeSidebar()">

    <!-- Header de la sidebar -->
    <div slot="header" class="flex-1">
      <!-- Logo et titre -->
      <div class="flex items-center mb-4">
        <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center mr-3">
          <svg class="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
            <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5zM15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
          </svg>
        </div>
        <h2 class="text-lg font-semibold text-white">ChatApp</h2>
      </div>

      <!-- Bouton Accueil -->
      <div class="mt-4">
        <button
          (click)="navigateToHome()"
          [class]="'w-full flex items-center p-3 text-left bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg transition-colors duration-200 ' +
                   (!currentChatMode() ? 'bg-opacity-30' : '')">
          <i class="fas fa-home mr-3" aria-hidden="true"></i>
          <div class="flex-1">
            <div class="text-sm font-medium">Accueil</div>
            <div class="text-xs opacity-75">Retour à l'accueil</div>
          </div>
          @if (!currentChatMode()) {
            <i class="fas fa-check text-sm" aria-hidden="true"></i>
          }
        </button>
      </div>

      <!-- Menu des modes de chat -->
      <div class="mt-4">
        <button
          (click)="toggleChatModesMenu()"
          class="w-full flex items-center justify-between p-3 text-left bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg transition-colors duration-200">
          <div class="flex items-center">
            <i class="fas fa-layer-group mr-3" aria-hidden="true"></i>
            <span class="font-medium">Modes de Chat</span>
          </div>
          <i [class]="'fas transition-transform duration-200 ' + (chatModesExpanded() ? 'fa-chevron-up' : 'fa-chevron-down')"
             aria-hidden="true"></i>
        </button>

        <!-- Menu expandable -->
        @if (chatModesExpanded()) {
          <div class="mt-2 space-y-1">
            @for (mode of chatModes; track mode.id) {
              <button
                (click)="navigateToChatMode(mode)"
                [class]="'w-full flex items-center p-2 text-left rounded-lg transition-colors duration-200 hover:bg-white hover:bg-opacity-20 text-white ' +
                         (currentChatMode() === mode.id ? 'bg-white bg-opacity-30' : '')">
                <i [class]="'fas ' + mode.icon + ' mr-3 text-sm'" aria-hidden="true"></i>
                <div class="flex-1">
                  <div class="text-sm font-medium">{{ mode.label }}</div>
                  <div class="text-xs opacity-75">{{ mode.description }}</div>
                </div>
                @if (currentChatMode() === mode.id) {
                  <i class="fas fa-check text-sm" aria-hidden="true"></i>
                }
              </button>
            }
          </div>
        }
      </div>
    </div>

    <!-- Contenu de la sidebar -->
    <div slot="content">
      <!-- Liste des conversations -->
      <div class="px-2">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3 px-4">
          Conversations
        </h3>

        <div class="space-y-1">
          <div
            *ngFor="let conversation of conversations"
            (click)="navigateToChat(conversation.id)"
            class="group relative flex items-center p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-all duration-200 border border-transparent hover:border-gray-200">

            <!-- Avatar/Icon -->
            <div class="mr-3 flex-shrink-0">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5zM15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
                </svg>
              </div>
            </div>

            <!-- Contenu de la conversation -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between mb-1">
                <h4 class="text-sm font-medium text-gray-900 truncate">{{ conversation.title }}</h4>
                <span class="text-xs text-gray-500">{{ formatTimestamp(conversation.timestamp) }}</span>
              </div>
              <p class="text-xs text-gray-600 truncate">{{ conversation.lastMessage }}</p>
            </div>

            <!-- Badge non lus -->
            <div *ngIf="conversation.unreadCount > 0" class="ml-2 flex-shrink-0">
              <span class="inline-flex items-center justify-center w-5 h-5 bg-blue-500 text-white text-xs font-medium rounded-full">
                {{ conversation.unreadCount }}
              </span>
            </div>

            <!-- Bouton supprimer (visible au hover) -->
            <button
              (click)="deleteConversation(conversation.id, $event)"
              class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 p-1 hover:bg-red-100 rounded text-red-500 hover:text-red-700">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer de la sidebar -->
    <div slot="footer">
      <div class="p-4 border-t border-gray-200 bg-white">
        <!-- Profil utilisateur -->
        <div class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors duration-200">
          <!-- Avatar -->
          <div class="flex-shrink-0">
            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
              <span class="text-white font-medium text-sm">EU</span>
            </div>
          </div>

          <!-- Informations utilisateur -->
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-900 truncate">Emman Utilisateur</p>
            <p class="text-xs text-gray-500 truncate">emmanu&#64;example.com</p>
          </div>

          <!-- Icône paramètres -->
          <div class="flex-shrink-0">
            <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </app-sidebar>

  <!-- Zone principale avec header et contenu -->
  <div class="flex-1 flex flex-col overflow-hidden md:ml-80 transition-all duration-300 ease-in-out">

    <!-- Header avec ng-content -->
    <app-header
      [title]="title"
      [showNotificationButton]="true"
      [notificationCount]="3"
      (toggleEvent)="toggleSidebar()">

      <!-- Contenu header personnalisé -->
      <div slot="right">
        <ng-content select="[header]"></ng-content>
      </div>

      <!-- Actions additionnelles -->
      <div slot="actions">
        <button class="p-2 rounded-lg hover:bg-gray-100 transition-colors duration-200 text-gray-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
        </button>
      </div>
    </app-header>

    <!-- Contenu principal -->
    <main class="flex-1 overflow-y-auto bg-gray-50">
      <div class="p-8">
        <ng-content></ng-content>
        <router-outlet></router-outlet>
      </div>
    </main>

    <!-- Footer avec ng-content -->
    <app-footer [companyName]="'Template Widget'" [hasContent]="hasFooterContent()">
      <!-- Input field de type text -->
      <div footer class="p-4 border-t border-gray-200 bg-white">
        <!-- Affichage du mode de chat sélectionné -->
        @if (currentChatModeInfo()) {
          <div class="mb-2 flex items-center justify-center">
            <div class="flex items-center space-x-2 px-3 py-1 bg-gray-50 rounded-full border">
              <i [class]="'fas ' + currentChatModeInfo()!.icon + ' ' + currentChatModeInfo()!.color" aria-hidden="true"></i>
              <span class="text-sm font-medium text-gray-700">{{ currentChatModeInfo()!.label }}</span>
            </div>
          </div>
        }

        <!-- Affichage du modèle sélectionné -->
        <div class="mb-3 flex items-center justify-center space-x-3">
          <!-- Sélecteur de modèle -->
          <app-select
            [options]="modelSelectOptions"
            [value]="selectedModel().id"
            [openUpward]="true"
            placeholder="Choisir un modèle"
            (selection)="onModelSelect($event)"
            buttonClass="bg-gray-50 hover:bg-gray-100 border-gray-200 text-sm"
            menuClass="border-gray-200 min-w-[280px]"
            hostClass="inline-block">
          </app-select>

          <!-- Sélecteur de niveau de raisonnement (si le modèle supporte le reasoning) -->
          @if (selectedModel().has_reasoning) {
            <app-select
              [options]="reasoningLevelSelectOptions"
              [value]="selectedReasoningLevel()"
              [openUpward]="true"
              placeholder="Niveau de raisonnement"
              (selection)="onReasoningLevelSelect($event)"
              buttonClass="bg-blue-50 hover:bg-blue-100 border-blue-200 text-sm text-blue-700"
              menuClass="border-blue-200 min-w-[200px]"
              hostClass="inline-block">
            </app-select>
          }
        </div>

        <div class="flex justify-center">
          <div class="w-full md:w-[70%]">
            <app-input-field
              type="text"
              placeholder="Tapez votre message..."
              inputClass="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              (valueChange)="onFooterInputChange($event)">

              <!-- Prepend: Icon button à gauche -->
              <app-icon-button
                prepend
                iconClass="fas fa-paperclip"
                ariaLabel="Joindre un fichier"
                buttonClass="p-2 text-gray-400 hover:text-gray-600 transition-colors duration-200 bg-transparent">
              </app-icon-button>

              <!-- Append: Boutons microphone et envoi -->
              <div append class="flex items-center space-x-2">
                <!-- Bouton microphone -->
                <app-icon-button
                  iconClass="fas fa-microphone"
                  ariaLabel="Enregistrement vocal"
                  buttonClass="p-2 text-gray-400 hover:text-blue-500 transition-colors duration-200 bg-transparent"
                  (pressed)="onMicrophoneClick()">
                </app-icon-button>

                <!-- Bouton envoi -->
                <app-icon-button
                  iconClass="fas fa-paper-plane"
                  ariaLabel="Envoyer le message"
                  buttonClass="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200"
                  [disabled]="isSendButtonDisabled"
                  (pressed)="onSendMessage()">
                </app-icon-button>
              </div>

            </app-input-field>
          </div>
        </div>
      </div>
    </app-footer>
  </div>

  <!-- Overlay pour mobile -->
  <app-overlay
    [show]="sidebarOpen()"
    (clickEvent)="closeSidebar()">
  </app-overlay>
</div>
